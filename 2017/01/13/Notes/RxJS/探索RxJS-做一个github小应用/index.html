<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Table of Contents  generated with DocToc

探索 RxJS - 做一个 github 小应用
Let’s start
初始化 DOM 事件流
实时进行异步获取
优化事件流
流的监听
更加优雅的 Rx 风格
创建基于hover的事件流


APIS
扩展阅读


探索 RxJS - 做一个 github 小应用本文是一篇 RxJS 实战教程，利用 RxJS">
<meta property="og:type" content="article">
<meta property="og:title" content="探索RxJS-做一个github小应用">
<meta property="og:url" content="http://ecmadao.com/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/index.html">
<meta property="og:site_name" content="ecmadao">
<meta property="og:description" content="Table of Contents  generated with DocToc

探索 RxJS - 做一个 github 小应用
Let’s start
初始化 DOM 事件流
实时进行异步获取
优化事件流
流的监听
更加优雅的 Rx 风格
创建基于hover的事件流


APIS
扩展阅读


探索 RxJS - 做一个 github 小应用本文是一篇 RxJS 实战教程，利用 RxJS">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/search_repos.png">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/fetch_info.png">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/flatMap.png">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/debounce.png">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/distinctUntilChanged.png">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/flatMapLatest.png">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/rxjs-example.png">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/do.png">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/userinfo-loading.png">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/userinfo-info.png">
<meta property="og:image" content="http://ecmadao.com/images/RxJS/takeWhile.png">
<meta property="og:updated_time" content="2017-01-14T12:11:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="探索RxJS-做一个github小应用">
<meta name="twitter:description" content="Table of Contents  generated with DocToc

探索 RxJS - 做一个 github 小应用
Let’s start
初始化 DOM 事件流
实时进行异步获取
优化事件流
流的监听
更加优雅的 Rx 风格
创建基于hover的事件流


APIS
扩展阅读


探索 RxJS - 做一个 github 小应用本文是一篇 RxJS 实战教程，利用 RxJS">
<meta name="twitter:image" content="http://ecmadao.com/images/RxJS/search_repos.png">
    
    
        
          
              <link rel="shortcut icon" href="/Coding-Guide/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/Coding-Guide/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/Coding-Guide/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>探索RxJS-做一个github小应用</title>
    <!-- styles -->
    <link rel="stylesheet" href="/Coding-Guide/lib/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/Coding-Guide/lib/meslo-LG/styles.css">
    <link rel="stylesheet" href="/Coding-Guide/lib/justified-gallery/justifiedGallery.min.css">
    <link rel="stylesheet" href="/Coding-Guide/css/style.css">
    <!-- rss -->
    
    
    <!-- jquery -->
    <script src="/Coding-Guide/lib/jquery/jquery.min.js"></script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/Coding-Guide/">Home</a></li>
         
          <li><a href="/Coding-Guide/about/">About</a></li>
         
          <li><a href="/Coding-Guide/archives/">Articles</a></li>
         
          <li><a href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-Observable/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/Coding-Guide/2017/01/13/Notes/UnitTest/UnitTest in React/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&text=探索RxJS-做一个github小应用"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&title=探索RxJS-做一个github小应用"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&is_video=false&description=探索RxJS-做一个github小应用"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=探索RxJS-做一个github小应用&body=Check out this article: http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&title=探索RxJS-做一个github小应用"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&title=探索RxJS-做一个github小应用"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&title=探索RxJS-做一个github小应用"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&title=探索RxJS-做一个github小应用"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&name=探索RxJS-做一个github小应用&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#探索-RxJS-做一个-github-小应用"><span class="toc-number">1.</span> <span class="toc-text">探索 RxJS - 做一个 github 小应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Let’s-start"><span class="toc-number">2.</span> <span class="toc-text">Let’s start</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化-DOM-事件流"><span class="toc-number">2.1.</span> <span class="toc-text">初始化 DOM 事件流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实时进行异步获取"><span class="toc-number">2.2.</span> <span class="toc-text">实时进行异步获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化事件流"><span class="toc-number">2.3.</span> <span class="toc-text">优化事件流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流的监听"><span class="toc-number">2.4.</span> <span class="toc-text">流的监听</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更加优雅的-Rx-风格"><span class="toc-number">2.5.</span> <span class="toc-text">更加优雅的 Rx 风格</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建基于hover的事件流"><span class="toc-number">2.6.</span> <span class="toc-text">创建基于hover的事件流</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#APIS"><span class="toc-number">3.</span> <span class="toc-text">APIS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展阅读"><span class="toc-number">4.</span> <span class="toc-text">扩展阅读</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        探索RxJS-做一个github小应用
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ecmadao</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-01-13T05:58:37.000Z" itemprop="datePublished">2017-01-13</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/Coding-Guide/tags/RxJS/">RxJS</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong>  <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank" rel="external">DocToc</a></em></p>
<ul>
<li><a href="#%E6%8E%A2%E7%B4%A2-rxjs---%E5%81%9A%E4%B8%80%E4%B8%AA-github-%E5%B0%8F%E5%BA%94%E7%94%A8">探索 RxJS - 做一个 github 小应用</a></li>
<li><a href="#lets-start">Let’s start</a><ul>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96-dom-%E4%BA%8B%E4%BB%B6%E6%B5%81">初始化 DOM 事件流</a></li>
<li><a href="#%E5%AE%9E%E6%97%B6%E8%BF%9B%E8%A1%8C%E5%BC%82%E6%AD%A5%E8%8E%B7%E5%8F%96">实时进行异步获取</a></li>
<li><a href="#%E4%BC%98%E5%8C%96%E4%BA%8B%E4%BB%B6%E6%B5%81">优化事件流</a></li>
<li><a href="#%E6%B5%81%E7%9A%84%E7%9B%91%E5%90%AC">流的监听</a></li>
<li><a href="#%E6%9B%B4%E5%8A%A0%E4%BC%98%E9%9B%85%E7%9A%84-rx-%E9%A3%8E%E6%A0%BC">更加优雅的 Rx 风格</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E5%9F%BA%E4%BA%8Ehover%E7%9A%84%E4%BA%8B%E4%BB%B6%E6%B5%81">创建基于<code>hover</code>的事件流</a></li>
</ul>
</li>
<li><a href="#apis">APIS</a></li>
<li><a href="#%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB">扩展阅读</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="探索-RxJS-做一个-github-小应用"><a href="#探索-RxJS-做一个-github-小应用" class="headerlink" title="探索 RxJS - 做一个 github 小应用"></a>探索 RxJS - 做一个 github 小应用</h2><p>本文是一篇 RxJS 实战教程，利用 RxJS 和 github API 来一步步做一个 github 小应用。因此，文章的重点是解释 RxJS 的使用，而涉及的 ES6语法、webpack 等知识点不予讲解。</p>
<blockquote>
<p>本例的所有代码在 github 仓库：<a href="https://github.com/ecmadao/rxjs-example" target="_blank" rel="external">rxjs-example</a></p>
</blockquote>
<p>首先要注意的是，目前在 github 上有两个主流 RxJS，它们代表不同的版本：</p>
<ul>
<li><a href="https://github.com/ReactiveX/rxjs" target="_blank" rel="external">ReactiveX - rxjs</a> RxJS 5 beta 版</li>
<li><a href="https://github.com/Reactive-Extensions/RxJS" target="_blank" rel="external">Reactive-Extensions - RxJS</a> RxJS 4.x 稳定版</li>
</ul>
<p>这两个版本的安装和引用稍有不同：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 安装 4.x 稳定版</span></div><div class="line">$ npm install rx --save</div><div class="line"><span class="comment"># 安装 5 beta 版</span></div><div class="line">$ npm install rxjs --save</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 4.x 稳定版</span></div><div class="line"><span class="keyword">import</span> Rx <span class="keyword">from</span> <span class="string">'rx'</span>;</div><div class="line"><span class="comment">// 5 beta 版</span></div><div class="line"><span class="keyword">import</span> Rx <span class="keyword">from</span> <span class="string">'rxjs/Rx'</span>;</div></pre></td></tr></table></figure>
<p>除此以外，它们的语法也稍有不同，比如在 5 beta 版里，<code>subscribe</code>时可以代入一个对象作为参数，也可以代入回调函数作为参数，而 4.x 版则只支持以回调函数为参数的情况：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 5 beta</span></div><div class="line"><span class="keyword">var</span> observer = &#123;</div><div class="line">  <span class="attr">next</span>: <span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Observer got a next value: '</span> + x),</div><div class="line">  <span class="attr">error</span>: <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(<span class="string">'Observer got an error: '</span> + err),</div><div class="line">  <span class="attr">complete</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Observer got a complete notification'</span>),</div><div class="line">&#125;;</div><div class="line">Observable.subscribe(observer);</div><div class="line"></div><div class="line"><span class="comment">// 5 和 4.x 都支持：</span></div><div class="line">Observable.subscribe(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">console</span>.log(x), (err) =&gt; <span class="built_in">console</span>.log(err), () =&gt; <span class="built_in">console</span>.log(<span class="string">'completed'</span>));</div></pre></td></tr></table></figure>
<p>其他更多语法不同可以参考：</p>
<ul>
<li><a href="https://github.com/Reactive-Extensions/RxJS/tree/master/doc" target="_blank" rel="external">4.x 稳定版 Document</a></li>
<li><a href="http://reactivex.io/rxjs/manual" target="_blank" rel="external">5 beta 版 Document</a></li>
<li><a href="https://github.com/ReactiveX/rxjs/blob/master/MIGRATION.md" target="_blank" rel="external">从 4 到 5 的迁移</a></li>
</ul>
<h2 id="Let’s-start"><a href="#Let’s-start" class="headerlink" title="Let’s start"></a>Let’s start</h2><p>如上所说，我们要利用 RxJS 和 github API 来一步步做一个 github 小应用。首先完成其基本功能，即通过一个 input 输入文字，并实时根据 input 内值的变化去发送异步请求，调用 github API 进行搜索。如图所示（<a href="https://ecmadao.github.io/rxjs-example" target="_blank" rel="external">线上 Demo</a>）：</p>
<blockquote>
<p>通过<code>RxJS</code>，在输入过程中实时进行异步搜索：</p>
</blockquote>
<p><img src="/images/RxJS/search_repos.png" alt="search_repos"></p>
<blockquote>
<p><code>hover</code>到 avator 上之后异步获取用户信息</p>
</blockquote>
<p><img src="/images/RxJS/fetch_info.png" alt="fetch_info.png"></p>
<p>安装 webpack 配置编译环境，并使用 ES6 语法。安装如下依赖，并配置好 webpack：</p>
<ul>
<li>webpack</li>
<li>webpack-dev-server</li>
<li>babel-loader</li>
<li>babel-preset-es2015</li>
<li>html-webpack-plugin</li>
<li>css-loader / postcss 及其他</li>
<li>jquery</li>
<li>rx（4.x 版本）</li>
</ul>
<p>通过<code>webpack-dev-server</code>，我们将会启动一个 8080 端口的服务器，使得我们编译好的资源可以在<code>localhost:8080/webpack-dev-server</code>访问到。</p>
<h3 id="初始化-DOM-事件流"><a href="#初始化-DOM-事件流" class="headerlink" title="初始化 DOM 事件流"></a>初始化 DOM 事件流</h3><p>在<code>index.html</code>中编写一个<code>input</code>，我们将在<code>index.js</code>中，通过 RxJS 的 Observable 监听<code>input</code>的<code>keyup</code>事件。可以使用<a href="http://reactivex.io/documentation/operators/from.html" target="_blank" rel="external"><code>fromEvent</code></a>来创建一个基于 DOM 事件的流，并通过<a href="http://reactivex.io/documentation/operators/map.html" target="_blank" rel="external"><code>map</code></a>和<a href="http://reactivex.io/documentation/operators/filter.html" target="_blank" rel="external"><code>filter</code></a>进一步处理。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- index.html --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"search"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">maxlength</span>=<span class="string">"1000"</span> <span class="attr">required</span> <span class="attr">placeholder</span>=<span class="string">"search in github"</span>/&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="keyword">import</span> Rx <span class="keyword">from</span> <span class="string">'rx'</span>;</div><div class="line"></div><div class="line">$(() =&gt; &#123;</div><div class="line">  <span class="keyword">const</span> $input = $(<span class="string">'.search'</span>);</div><div class="line">  <span class="comment">// 通过 input 的 keyup 事件来创建流</span></div><div class="line">  <span class="keyword">const</span> observable = Rx.Observable.fromEvent($input, <span class="string">'keyup'</span>)</div><div class="line">  	<span class="comment">// 并获取每次 keyup 时搜索框的值，筛选出合法值</span></div><div class="line">  	.map(<span class="function"><span class="params">()</span> =&gt;</span> $input.val().trim())</div><div class="line">    .filter(<span class="function">(<span class="params">text</span>) =&gt;</span> !!text)</div><div class="line">    <span class="comment">// 利用 do 可以做一些不影响流的事件，比如这里打印出 input 的值</span></div><div class="line">    .do(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value));</div><div class="line">  <span class="comment">// 开启监听</span></div><div class="line">  observable.subscribe();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>去 input 里随便打打字，可以看到我们已经成功监听了<code>keyup</code>事件，并在每次<code>keyup</code>时在 console 里输出 input 当前的值。</p>
<h3 id="实时进行异步获取"><a href="#实时进行异步获取" class="headerlink" title="实时进行异步获取"></a>实时进行异步获取</h3><p>监听了 input 事件，我们就能够在每次<code>keyup</code>时拿到 value，那么就可以通过它来异步获取数据。将整个过程拆分一下：</p>
<ol>
<li>用户在 input 里输入任意内容</li>
<li>触发<code>keyup</code>事件，获取到当前 value</li>
<li>将 value 代入到一个异步方法里，通过接口获取数据</li>
<li>利用返回数据渲染 DOM</li>
</ol>
<p>也就是说，我们要把原有的 Observable 中每个事件返回的 value 进行异步处理，并使其返回一个新的 Observable。可以这么处理：</p>
<ol>
<li>让每个 value 返回一个 Observable</li>
<li>通过<a href="http://reactivex.io/documentation/operators/flatmap.html" target="_blank" rel="external"><code>flatMap</code></a>将所有的 Observable 扁平化，成为一个新的 Observable</li>
</ol>
<p>图解<code>flatMap</code>：</p>
<p><img src="/images/RxJS/flatMap.png" alt="flatMap"></p>
<p>而既然需要异步获取数据，那么在上面的第一步时，可以通过<a href="http://reactivex.io/documentation/operators/from.html" target="_blank" rel="external"><code>fromPromise</code></a>来创建一个 Observable：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/helper.js</span></div><div class="line"><span class="keyword">const</span> SEARCH_REPOS = <span class="string">'https://api.github.com/search/repositories?sort=stars&amp;order=desc&amp;q='</span>;</div><div class="line"></div><div class="line"><span class="comment">// 创建一个 ajax 的 promise</span></div><div class="line"><span class="keyword">const</span> getReposPromise = <span class="function">(<span class="params">query</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> $.ajax(&#123;</div><div class="line">  	<span class="attr">type</span>: <span class="string">"GET"</span>,</div><div class="line">    <span class="attr">url</span>: <span class="string">`<span class="subst">$&#123;SEARCH_REPOS&#125;</span><span class="subst">$&#123;query&#125;</span>`</span>,</div><div class="line">  &#125;).promise();</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 通过 fromPromise 创建一个 Observable</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> getRepos = <span class="function">(<span class="params">query</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> promise = getReposPromise(query);</div><div class="line">  <span class="keyword">return</span> Rx.Observable.fromPromise(promise);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="keyword">import</span> &#123;getRepos&#125; <span class="keyword">from</span> <span class="string">'./helper'</span>;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">const</span> observable = Rx.Observable.fromEvent($input, <span class="string">'keyup'</span>)</div><div class="line">  	.map(<span class="function"><span class="params">()</span> =&gt;</span> $input.val())</div><div class="line">    .filter(<span class="function">(<span class="params">text</span>) =&gt;</span> !!text)</div><div class="line">    .do(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value))</div><div class="line">    <span class="comment">// 调用 getRepos 方法将返回一个 Observable</span></div><div class="line">    <span class="comment">// flatMap 则将所有 Observable 合并，转为一个 Observable</span></div><div class="line">    .flatMap(getRepos);</div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure>
<p>这样，每一次<code>keyup</code>的时候，都会根据此时 input 的 value 去异步获取数据。但这样做有几个问题：</p>
<ul>
<li>不断打字时会连续不断触发异步请求，占用资源影响体验</li>
<li>如果相邻的<code>keyup</code>事件触发时 input 的值一样，也就是说按下了不改变 value 的按键（比如方向键），会重复触发一样的异步事件</li>
<li>发出多个异步事件之后，每个事件所耗费的时间不一定相同。如果前一个异步所用时间较后一个长，那么当它最终返回结果时，有可能把后面的异步率先返回的结果覆盖</li>
</ul>
<p>所以接下来我们就处理这几个问题。</p>
<h3 id="优化事件流"><a href="#优化事件流" class="headerlink" title="优化事件流"></a>优化事件流</h3><p>针对上面的问题，一步一步进行优化。</p>
<hr>
<blockquote>
<p>不断打字时会连续不断触发异步请求，占用资源影响体验</p>
</blockquote>
<p>也就是说，当用户在连续打字时，我们不应该继续进行之后的事件处理，而如果打字中断，或者说两次<code>keyup</code>事件的时间间隔足够长时，才应该发送异步请求。针对这点，可以使用 RxJS 的<a href="http://reactivex.io/documentation/operators/debounce.html" target="_blank" rel="external"><code>debounce</code></a>方法：</p>
<p><img src="/images/RxJS/debounce.png" alt="debounce"></p>
<p>如图所示，在一段时间内事件被不断触发时，不会被之后的操作所处理；只有超过指定时间间隔的事件才会留下来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">const</span> observable = Rx.Observable.fromEvent($input, <span class="string">'keyup'</span>)</div><div class="line">	<span class="comment">// 若 400ms 内连续触发 keyup 事件，则不会继续往下处理</span></div><div class="line">	.debounce(<span class="number">400</span>)</div><div class="line">  	.map(<span class="function"><span class="params">()</span> =&gt;</span> $input.val())</div><div class="line">    .filter(<span class="function">(<span class="params">text</span>) =&gt;</span> !!text)</div><div class="line">    .do(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value))</div><div class="line">    .flatMap(getRepos);</div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>如果相邻的<code>keyup</code>事件触发时 input 的值一样，也就是说按下了不改变 value 的按键（比如方向键），会重复触发一样的异步事件</p>
</blockquote>
<p>也就是说，对于任意相邻的事件，如果它们的返回值一样，则只要取一个（重复事件中的第一个）就好了。可以利用<a href="http://reactivex.io/documentation/operators/distinct.html" target="_blank" rel="external"><code>distinctUntilChanged</code></a>方法：</p>
<p><img src="/images/RxJS/distinctUntilChanged.png" alt="distinctUntilChanged"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">const</span> observable = Rx.Observable.fromEvent($input, <span class="string">'keyup'</span>)</div><div class="line">	.debounce(<span class="number">400</span>)</div><div class="line">  	.map(<span class="function"><span class="params">()</span> =&gt;</span> $input.val())</div><div class="line">    .filter(<span class="function">(<span class="params">text</span>) =&gt;</span> !!text)</div><div class="line">    <span class="comment">// 只取不一样的值进行异步</span></div><div class="line">    .distinctUntilChanged()</div><div class="line">    .do(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value))</div><div class="line">    .flatMap(getRepos);</div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>发出多个异步事件之后，每个事件所耗费的时间不一定相同。如果前一个异步所用时间较后一个长，那么当它最终返回结果时，有可能把后面的异步率先返回的结果覆盖</p>
</blockquote>
<p>这个蛋疼的问题我相信大家很可能遇见过。在发送多个异步请求时，因为所用时长不一定，无法保障异步返回的先后顺序，所以，有时候可能<strong>早请求的异步的结果会覆盖后来请求的异步结果</strong>。</p>
<p>而这种情况的处理方式就是，在连续发出多个异步的时候，既然我们期待的是最后一个异步返回的结果，那么就可以把之前的异步取消掉，不 care 其返回了什么。因此，我们可以使用<a href="http://reactivex.io/documentation/operators/flatmap.html" target="_blank" rel="external"><code>flatMapLatest</code></a> API（类似于 RxJava 中的<code>switchMap</code> API，同时在 RxJS 5.0 中也已经改名为<code>switchMap</code>）</p>
<p>通过<code>flatMapLatest</code>，当 Observable 触发某个事件，返回新的 Observable 时，将取消之前触发的事件，并且不再关心返回结果的处理，只监视当前这一个。也就是说，发送多个请求时，不关心之前请求的处理，只处理最后一次的请求：</p>
<p><img src="/images/RxJS/flatMapLatest.png" alt="flatMapLatest"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">const</span> observable = Rx.Observable.fromEvent($input, <span class="string">'keyup'</span>)</div><div class="line">	.debounce(<span class="number">400</span>)</div><div class="line">  	.map(<span class="function"><span class="params">()</span> =&gt;</span> $input.val())</div><div class="line">    .filter(<span class="function">(<span class="params">text</span>) =&gt;</span> !!text)</div><div class="line">    .distinctUntilChanged()</div><div class="line">    .do(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value))</div><div class="line">    <span class="comment">// 仅处理最后一次的异步</span></div><div class="line">    .flatMapLatest(getRepos);</div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure>
<h3 id="流的监听"><a href="#流的监听" class="headerlink" title="流的监听"></a>流的监听</h3><p>至此，我们对 input <code>keyup</code>以及异步获取数据的整个事件流处理完毕，并进行了一定的优化，避免了过多的请求、异步返回结果错乱等问题。但创建了一个流之后也有对其进行监听：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">const</span> observable = Rx.Observable.fromEvent($input, <span class="string">'keyup'</span>)</div><div class="line">	.debounce(<span class="number">400</span>)</div><div class="line">  	.map(<span class="function"><span class="params">()</span> =&gt;</span> $input.val())</div><div class="line">    .filter(<span class="function">(<span class="params">text</span>) =&gt;</span> !!text)</div><div class="line">    .distinctUntilChanged()</div><div class="line">    .do(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value))</div><div class="line">    .flatMapLatest(getRepos);</div><div class="line"><span class="comment">// 第一个回调中的 data 代表异步的返回值</span></div><div class="line">observable.subscribe(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</div><div class="line">  <span class="comment">// 在 showNewResults 方法中使用返回值渲染 DOM</span></div><div class="line">  showNewResults(data);</div><div class="line">&#125;, (err) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(err);</div><div class="line">&#125;, () =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'completed'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 异步返回的结果是个 Array，代表搜索到的各个仓库 item</span></div><div class="line"><span class="comment">// 遍历所有 item，转化为 jQuery 对象，最后插入到 content_container 中</span></div><div class="line"><span class="keyword">const</span> showNewResults = <span class="function">(<span class="params">items</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> repos = items.map(<span class="function">(<span class="params">item, i</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> reposTemplate(item);</div><div class="line">  &#125;).join(<span class="string">''</span>);</div><div class="line">  $(<span class="string">'.content_container'</span>).html(repos);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<hr>
<p>这样，一个通过 RxJS 监听事件的流已经完全建立完毕了。整个过程使用图像来表示则如下：</p>
<p><img src="/images/RxJS/rxjs-example.png" alt="rxjs-example"></p>
<p>而如果我们不使用 RxJS，用传统方式监听 input 的话：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="keyword">import</span> &#123;getRepos&#125; <span class="keyword">from</span> <span class="string">'./helper'</span>;</div><div class="line"></div><div class="line">$(() =&gt; &#123;</div><div class="line">  <span class="keyword">const</span> $input = $(<span class="string">'.search'</span>);</div><div class="line">  <span class="keyword">const</span> interval = <span class="number">400</span>;</div><div class="line">  <span class="keyword">var</span> previousValue = <span class="literal">null</span>;</div><div class="line">  <span class="keyword">var</span> fetching = <span class="literal">false</span>;</div><div class="line">  <span class="keyword">var</span> lastKeyUp = <span class="built_in">Date</span>.now() - interval;</div><div class="line">  $input.on(<span class="string">'keyup'</span>, (e) =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> nextValue = $input.val();</div><div class="line">	<span class="keyword">if</span> (!nextValue) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (<span class="built_in">Date</span>.now() - lastKeyUp &lt;= interval) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	lastKeyUp = <span class="built_in">Date</span>.now();</div><div class="line">	<span class="keyword">if</span> (nextValue === previousValue) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	previousValue = nextValue;</div><div class="line">    <span class="keyword">if</span> (!fetching) &#123;</div><div class="line">      fetching = <span class="literal">true</span>;</div><div class="line">      getRepos(nextValue).then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</div><div class="line">      	fetching = <span class="literal">false</span>;</div><div class="line">        showNewResults(data);</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>挺复杂了吧？而且即便如此，这样的处理还是不够到位。上面仅仅是通过<code>fetching</code>变量来判断是否正在异步，如果正在异步，则不进行新的异步；而我们更希望的是能够取消旧的异步，只处理新的异步请求。</p>
<h3 id="更加优雅的-Rx-风格"><a href="#更加优雅的-Rx-风格" class="headerlink" title="更加优雅的 Rx 风格"></a>更加优雅的 Rx 风格</h3><p>按照上面的教程，我们在 Observable 中获取到了数据、发送异步请求并拿到了最新一次的返回值。之后，再通过<code>subscribe</code>，在监听的回调中将返回值拼接成 HTML 并插入 DOM。</p>
<p>但是有一个问题：小应用的另一个功能是，当鼠标<code>hover</code>到头像上时，异步获取并展现用户的信息。可是用户头像是在<code>subscribe</code>回调中动态插入的，又该如何创建事件流呢？当然了，可以在每次插入 DOM 之后在利用<code>fromEvent</code>创建一个基于<code>hover</code>的事件流，但那样总是不太好的，写出来的代码也不够 Rx。或许我们就不应该在<code>.flatMapLatest(getRepos)</code>之后中断流的传递？但那样的话，又该如何把异步的返回值插入 DOM 呢？</p>
<p>针对这种情况，我们可以使用 RxJS 的<a href="http://reactivex.io/documentation/operators/do.html" target="_blank" rel="external"><code>do</code></a>方法：</p>
<p><img src="/images/RxJS/do.png" alt="do"></p>
<p>你想在<code>do</code>的回调内做什么都可以，它不会影响到流内的事件；除此以外，还可以拿到流中各个事件的返回值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> observable = Rx.Observable.from([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>])</div><div class="line">    .do(<span class="function">(<span class="params">x</span>) =&gt;</span> <span class="built_in">console</span>.log(x))</div><div class="line">    .map(<span class="function">(<span class="params">x</span>) =&gt;</span> x + <span class="number">1</span>);</div><div class="line">observable.subscribe(<span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(x);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>所以，我们可以利用<code>do</code>来完成 DOM 的渲染：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="comment">// $conatiner 是装载搜索结果的容器 div</span></div><div class="line"><span class="keyword">const</span> $conatiner = $(<span class="string">'.content_container'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> observable = Rx.Observable.fromEvent($input, <span class="string">'keyup'</span>)</div><div class="line">	.debounce(<span class="number">400</span>)</div><div class="line">  	.map(<span class="function"><span class="params">()</span> =&gt;</span> $input.val())</div><div class="line">    .filter(<span class="function">(<span class="params">text</span>) =&gt;</span> !!text)</div><div class="line">    .distinctUntilChanged()</div><div class="line">    .do(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value))</div><div class="line">    .flatMapLatest(getRepos)</div><div class="line">    <span class="comment">// 首先把之前的搜索结果清空</span></div><div class="line">    .do(<span class="function">(<span class="params">results</span>) =&gt;</span> $conatiner.html(<span class="string">''</span>))</div><div class="line">    <span class="comment">// 利用 Rx.Observable.from 将异步的结果转化为 Observable，并通过 flatMap 合并到原有的流中。此时流中的每个元素是 results 中的每个 item</span></div><div class="line">    .flatMap(<span class="function">(<span class="params">results</span>) =&gt;</span> Rx.Observable.from(results))</div><div class="line">    <span class="comment">// 将各 item 转化为 jQuery 对象</span></div><div class="line">    .map(<span class="function">(<span class="params">repos</span>) =&gt;</span> $(reposTemplate(repos)))</div><div class="line">    <span class="comment">// 最后把每个 jQuery 对象依次加到容器里</span></div><div class="line">    .do(<span class="function">(<span class="params">$repos</span>) =&gt;</span> &#123;</div><div class="line">      $conatiner.append($repos);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line"><span class="comment">// 在 subscribe 中实际上什么都不用做，就能达到之前的效果</span></div><div class="line">observable.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'success'</span>);</div><div class="line">&#125;, (err) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(err);</div><div class="line">&#125;, () =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'completed'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>简直完美！现在我们这个<code>observable</code>在最后通过<code>map</code>，依次返回了一个 jQuery 对象。那么之后如果要对头像添加<code>hover</code>的监听，则可以在这个流的基础上继续进行。</p>
<h3 id="创建基于hover的事件流"><a href="#创建基于hover的事件流" class="headerlink" title="创建基于hover的事件流"></a>创建基于<code>hover</code>的事件流</h3><p>我们接下来针对用户头像的<code>hover</code>事件创建一个流。用户的详细资料是异步加载的，而<code>hover</code>到头像上时弹出 modal。如果是第一个<code>hover</code>，则 modal 里只有一个 loading 的图标，并且异步获取数据，之后将返回的数据插入到 modal 里；而如果已经拿到并插入好了数据，则不再有异步请求，直接展示：</p>
<blockquote>
<p>没有数据时展示 loading，同时异步获取数据</p>
</blockquote>
<p><img src="/images/RxJS/userinfo-loading.png" alt="userinfo-loading"></p>
<blockquote>
<p>异步返回后插入数据。且如果已经有了数据则直接展示</p>
</blockquote>
<p><img src="/images/RxJS/userinfo-info.png" alt="userinfo-info"></p>
<p>先不管上一个流，我们先创建一个新的事件流：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">const</span> initialUserInfoSteam = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> $avator = $(<span class="string">'.user_header'</span>);</div><div class="line">  <span class="comment">// 通过头像 $avator 的 hover 事件来创建流</span></div><div class="line">  <span class="keyword">const</span> avatorMouseover = Rx.Observable.fromEvent($avator, <span class="string">'mouseover'</span>)</div><div class="line">    <span class="comment">// 500ms 内重复触发事件则会被忽略</span></div><div class="line">    .debounce(<span class="number">500</span>)</div><div class="line">    <span class="comment">// 只有当满足了下列条件的流才会继续执行，否则将中断</span></div><div class="line">    .takeWhile(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</div><div class="line">      <span class="comment">// 异步获取的用户信息被新建到 DOM 里，该 DOM 最外层是 infos_container</span></div><div class="line">      <span class="comment">// 因此，如果已经有了 infos_container，则可以认为我们已经异步获取过数据了，此时 takeWhile 将返回 false，流将会中断</span></div><div class="line">      <span class="keyword">const</span> $infosWrapper = $(e.target).parent().find(<span class="string">'.user_infos_wrapper'</span>);</div><div class="line">      <span class="keyword">return</span> $infosWrapper.find(<span class="string">'.infos_container'</span>).length === <span class="number">0</span>;</div><div class="line">    &#125;)</div><div class="line">    .map(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> $infosWrapper = $(e.target).parent().find(<span class="string">'.user_infos_wrapper'</span>);</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">conatiner</span>: $infosWrapper,</div><div class="line">        <span class="attr">url</span>: $(e.target).attr(<span class="string">'data-api'</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">    .filter(<span class="function">(<span class="params">data</span>) =&gt;</span> !!data.url)</div><div class="line">    <span class="comment">// getUser 来异步获取用户信息</span></div><div class="line">    .flatMapLatest(getUser)</div><div class="line">    .do(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</div><div class="line">      <span class="comment">// 将用户信息组建成为 DOM 元素，并插入到页面中。在这之后，该用户对应的 DOM 里就会拥有 infos_container 这个 div，所以 takeWhile 会返回 false。也就是说，之后再 hover 上去，流也不会被触发了</span></div><div class="line">      <span class="keyword">const</span> &#123;data, conatiner&#125; = result;</div><div class="line">      showUserInfo(conatiner, data);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">  avatorMouseover.subscribe(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</div><div class="line">  	<span class="built_in">console</span>.log(<span class="string">'fetch user info succeed'</span>);</div><div class="line">  &#125;, (err) =&gt; &#123;</div><div class="line">    <span class="built_in">console</span>.log(err);</div><div class="line">  &#125;, () =&gt; &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'completed'</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>上面的代码中有一个 API 需要讲解：<a href="http://reactivex.io/documentation/operators/takewhile.html" target="_blank" rel="external"><code>takeWhile</code></a></p>
<p><img src="/images/RxJS/takeWhile.png" alt="takeWhile"></p>
<p>由图可知，当<code>takeWhile</code>中的回调返回<code>true</code>时，流可以正常进行；而一旦返回<code>false</code>，则之后的事件不会再发生，流将直接终止：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> source = Rx.Observable.range(<span class="number">1</span>, <span class="number">5</span>)</div><div class="line">    .takeWhile(<span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123; <span class="keyword">return</span> x &lt; <span class="number">3</span>; &#125;);</div><div class="line"></div><div class="line"><span class="keyword">var</span> subscription = source.subscribe(</div><div class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'Next: '</span> + x); &#125;,</div><div class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'Error: '</span> + err); &#125;,</div><div class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'Completed'</span>); &#125;);</div><div class="line"><span class="comment">// Next: 0</span></div><div class="line"><span class="comment">// Next: 1</span></div><div class="line"><span class="comment">// Next: 2</span></div><div class="line"><span class="comment">// Completed</span></div></pre></td></tr></table></figure>
<hr>
<p>创建好针对<code>hover</code>的事件流，我们可以把它和上一个事件流结合起来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">const</span> initialUserInfoSteam = <span class="function">(<span class="params">$repos</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> $avator = $repos.find(<span class="string">'.user_header'</span>);</div><div class="line">  <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> observable = Rx.Observable.fromEvent($input, <span class="string">'keyup'</span>)</div><div class="line">	<span class="comment">// ...</span></div><div class="line">	.do(<span class="function">(<span class="params">$repos</span>) =&gt;</span> &#123;</div><div class="line">      $conatiner.append($repos);</div><div class="line">      initialUserInfoSteam($repos);</div><div class="line">    &#125;);</div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure>
<p>现在这样就已经可以使用了，但依旧不够好。目前总共有两个流：监听 input <code>keyup</code>的流和监听<code>mouseover</code>的流。但是，因为用户头像是动态插入的 ，所以我们必须在<code>$conatiner.append($repos);</code>之后才能创建并监听<code>mouseover</code>。不过鉴于我们已经在最后的<code>do</code>方法里插入了获取的数据，所以可以试着把两个流合并到一起：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/js/index.js</span></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">const</span> initialUserInfoSteam = <span class="function">(<span class="params">$repos</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> $avator = $repos.find(<span class="string">'.user_header'</span>);</div><div class="line">  <span class="keyword">const</span> avatorMouseover = Rx.Observable.fromEvent($avator, <span class="string">'mouseover'</span>)</div><div class="line">  <span class="comment">// ... 流的处理跟之前的一样</span></div><div class="line">  <span class="comment">// 但我们不再需要 subscribe 它，而是返回这个 Observable</span></div><div class="line">  <span class="keyword">return</span> avatorMouseover;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> observable = Rx.Observable.fromEvent($input, <span class="string">'keyup'</span>)</div><div class="line">	<span class="comment">// ...</span></div><div class="line">	.do(<span class="function">(<span class="params">$repos</span>) =&gt;</span> &#123;</div><div class="line">      $conatiner.append($repos);</div><div class="line">      <span class="comment">// 不再在 do 里面创建新的流并监听</span></div><div class="line">      <span class="comment">// initialUserInfoSteam($repos);</span></div><div class="line">    &#125;)</div><div class="line">    <span class="comment">// 相反，我们继续这个流的传递，只是通过 flatMap 将原来的流变成了监听 mouseover 的流</span></div><div class="line">    .flatMap(<span class="function">(<span class="params">$repos</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">return</span> initialUserInfoSteam($repos);</div><div class="line">    &#125;);</div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure>
<p>DONE ！</p>
<h2 id="APIS"><a href="#APIS" class="headerlink" title="APIS"></a>APIS</h2><p>栗子中使用到的 RxJS API：</p>
<ul>
<li><a href="http://reactivex.io/documentation/operators/from.html" target="_blank" rel="external"><code>from</code></a> 通过一个可迭代对象来创建流</li>
<li><a href="http://reactivex.io/documentation/operators/from.html" target="_blank" rel="external"><code>fromEvent</code></a> 通过 DOM 事件来创建流</li>
<li><a href="http://reactivex.io/documentation/operators/debounce.html" target="_blank" rel="external"><code>debounce</code></a> 如果在一定时间内流中的某个事件不断被触发，则不会进行之后的事件操作</li>
<li><a href="http://reactivex.io/documentation/operators/map.html" target="_blank" rel="external"><code>map</code></a> 遍历流中所有事件，返回新的流</li>
<li><a href="http://reactivex.io/documentation/operators/filter.html" target="_blank" rel="external"><code>filter</code></a> 筛选流中所有事件，返回新的流</li>
<li><a href="http://reactivex.io/documentation/operators/flatmap.html" target="_blank" rel="external"><code>flatMap</code></a> 对各个事件返回的值进行处理并返回 Observable，然后将所有的 Observable 扁平化，成为一个新的 Observable</li>
<li><a href="http://reactivex.io/documentation/operators/flatmap.html" target="_blank" rel="external"><code>flatMapLatest</code></a> 对各个事件返回的值进行处理并返回 Observable，然后将所有的 Observable 扁平化，成为一个新的 Observable。但只会获取最后一次返回的 Observable，其他的返回结果不予处理</li>
<li><a href="http://reactivex.io/documentation/operators/distinct.html" target="_blank" rel="external"><code>distinctUntilChanged</code></a> 流中如果相邻事件的结果一样，则仅筛选出一个（剔除重复值）</li>
<li><a href="http://reactivex.io/documentation/operators/do.html" target="_blank" rel="external"><code>do</code></a> 可以依次拿到流上每个事件的返回值，利用其做一些无关流传递的事情</li>
<li><a href="http://reactivex.io/documentation/operators/takewhile.html" target="_blank" rel="external"><code>takeWhile</code></a> 给予流一个判断，只有当<code>takeWhile</code>中的回调返回<code>true</code>时，流才会继续执行；否则将中断之后的事件</li>
</ul>
<h2 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2><ul>
<li><a href="http://stackoverflow.com/questions/30840247/what-does-rxjs-observable-debounce-do" target="_blank" rel="external">What does RxJS observable debounce do</a></li>
<li><a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/howdoi/jquery.md" target="_blank" rel="external">How do I work with jQuery and RxJS</a></li>
<li><a href="http://reactivex.io/documentation/operators.html" target="_blank" rel="external">Introduction of observable operators</a></li>
<li><a href="https://github.com/ecmadao/rxjs-example" target="_blank" rel="external">文章源码 - rxjs-example</a></li>
<li><a href="http://www.infoq.com/cn/articles/functional-reactive-programming" target="_blank" rel="external">函数式反应型编程(FRP) —— 实时互动应用开发的新思路</a></li>
</ul>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/Coding-Guide/">Home</a></li>
         
          <li><a href="/Coding-Guide/about/">About</a></li>
         
          <li><a href="/Coding-Guide/archives/">Articles</a></li>
         
          <li><a href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#探索-RxJS-做一个-github-小应用"><span class="toc-number">1.</span> <span class="toc-text">探索 RxJS - 做一个 github 小应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Let’s-start"><span class="toc-number">2.</span> <span class="toc-text">Let’s start</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化-DOM-事件流"><span class="toc-number">2.1.</span> <span class="toc-text">初始化 DOM 事件流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实时进行异步获取"><span class="toc-number">2.2.</span> <span class="toc-text">实时进行异步获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化事件流"><span class="toc-number">2.3.</span> <span class="toc-text">优化事件流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流的监听"><span class="toc-number">2.4.</span> <span class="toc-text">流的监听</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更加优雅的-Rx-风格"><span class="toc-number">2.5.</span> <span class="toc-text">更加优雅的 Rx 风格</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建基于hover的事件流"><span class="toc-number">2.6.</span> <span class="toc-text">创建基于hover的事件流</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#APIS"><span class="toc-number">3.</span> <span class="toc-text">APIS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展阅读"><span class="toc-number">4.</span> <span class="toc-text">扩展阅读</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&text=探索RxJS-做一个github小应用"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&title=探索RxJS-做一个github小应用"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&is_video=false&description=探索RxJS-做一个github小应用"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=探索RxJS-做一个github小应用&body=Check out this article: http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&title=探索RxJS-做一个github小应用"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&title=探索RxJS-做一个github小应用"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&title=探索RxJS-做一个github小应用"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&title=探索RxJS-做一个github小应用"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/RxJS/探索RxJS-做一个github小应用/&name=探索RxJS-做一个github小应用&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 ecmadao
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/Coding-Guide/">Home</a></li>
         
          <li><a href="/Coding-Guide/about/">About</a></li>
         
          <li><a href="/Coding-Guide/archives/">Articles</a></li>
         
          <li><a href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    <script src="/Coding-Guide/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/Coding-Guide/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'ecmadao-blog';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
