<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Table of Contents  generated with DocToc

Redux入坑进阶-源码解析
预热
柯里化函数（curry）
代码组合（compose）


Redux
combineReducers
createStore
thunkMiddleware
applyMiddleware
bindActionCreator
bindActionCreator源码解析


r">
<meta property="og:type" content="article">
<meta property="og:title" content="Redux入坑进阶-源码解析">
<meta property="og:url" content="http://ecmadao.com/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/index.html">
<meta property="og:site_name" content="ecmadao">
<meta property="og:description" content="Table of Contents  generated with DocToc

Redux入坑进阶-源码解析
预热
柯里化函数（curry）
代码组合（compose）


Redux
combineReducers
createStore
thunkMiddleware
applyMiddleware
bindActionCreator
bindActionCreator源码解析


r">
<meta property="og:updated_time" content="2017-01-14T13:18:58.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redux入坑进阶-源码解析">
<meta name="twitter:description" content="Table of Contents  generated with DocToc

Redux入坑进阶-源码解析
预热
柯里化函数（curry）
代码组合（compose）


Redux
combineReducers
createStore
thunkMiddleware
applyMiddleware
bindActionCreator
bindActionCreator源码解析


r">
    
    
        
          
              <link rel="shortcut icon" href="/Coding-Guide/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/Coding-Guide/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/Coding-Guide/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Redux入坑进阶-源码解析</title>
    <!-- styles -->
    <link rel="stylesheet" href="/Coding-Guide/lib/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/Coding-Guide/lib/meslo-LG/styles.css">
    <link rel="stylesheet" href="/Coding-Guide/lib/justified-gallery/justifiedGallery.min.css">
    <link rel="stylesheet" href="/Coding-Guide/css/style.css">
    <!-- rss -->
    
    
    <!-- jquery -->
    <script src="/Coding-Guide/lib/jquery/jquery.min.js"></script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/Coding-Guide/">Home</a></li>
         
          <li><a href="/Coding-Guide/about/">About</a></li>
         
          <li><a href="/Coding-Guide/archives/">Articles</a></li>
         
          <li><a href="http://github.com/ecmadao">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑笔记-ThinkInRedux/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/Coding-Guide/2017/01/13/Notes/译文/ES6/【译文】用ES6写更赞的JavaScript（1）/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&text=Redux入坑进阶-源码解析"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&title=Redux入坑进阶-源码解析"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&is_video=false&description=Redux入坑进阶-源码解析"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Redux入坑进阶-源码解析&body=Check out this article: http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&title=Redux入坑进阶-源码解析"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&title=Redux入坑进阶-源码解析"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&title=Redux入坑进阶-源码解析"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&title=Redux入坑进阶-源码解析"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&name=Redux入坑进阶-源码解析&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redux入坑进阶-源码解析"><span class="toc-number">1.</span> <span class="toc-text">Redux入坑进阶-源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#预热"><span class="toc-number">1.1.</span> <span class="toc-text">预热</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#柯里化函数（curry）"><span class="toc-number">1.1.1.</span> <span class="toc-text">柯里化函数（curry）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代码组合（compose）"><span class="toc-number">1.1.2.</span> <span class="toc-text">代码组合（compose）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redux"><span class="toc-number">1.2.</span> <span class="toc-text">Redux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#combineReducers"><span class="toc-number">1.2.1.</span> <span class="toc-text">combineReducers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#createStore"><span class="toc-number">1.2.2.</span> <span class="toc-text">createStore</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#thunkMiddleware"><span class="toc-number">1.2.3.</span> <span class="toc-text">thunkMiddleware</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#applyMiddleware"><span class="toc-number">1.2.4.</span> <span class="toc-text">applyMiddleware</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bindActionCreator"><span class="toc-number">1.2.5.</span> <span class="toc-text">bindActionCreator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bindActionCreator源码解析"><span class="toc-number">1.2.6.</span> <span class="toc-text">bindActionCreator源码解析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#react-redux"><span class="toc-number">1.3.</span> <span class="toc-text">react-redux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Provider"><span class="toc-number">1.3.1.</span> <span class="toc-text">Provider</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#connect"><span class="toc-number">1.3.2.</span> <span class="toc-text">connect</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Redux入坑进阶-源码解析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ecmadao</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-01-13T05:58:37.000Z" itemprop="datePublished">2017-01-13</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/Coding-Guide/tags/React/">React</a>, <a class="tag-link" href="/Coding-Guide/tags/Redux/">Redux</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong>  <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank" rel="external">DocToc</a></em></p>
<ul>
<li><a href="#redux%E5%85%A5%E5%9D%91%E8%BF%9B%E9%98%B6-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">Redux入坑进阶-源码解析</a><ul>
<li><a href="#%E9%A2%84%E7%83%AD">预热</a><ul>
<li><a href="#%E6%9F%AF%E9%87%8C%E5%8C%96%E5%87%BD%E6%95%B0%EF%BC%88curry%EF%BC%89">柯里化函数（<code>curry</code>）</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81%E7%BB%84%E5%90%88%EF%BC%88compose%EF%BC%89">代码组合（<code>compose</code>）</a></li>
</ul>
</li>
<li><a href="#redux"><code>Redux</code></a><ul>
<li><a href="#combinereducers"><code>combineReducers</code></a></li>
<li><a href="#createstore"><code>createStore</code></a></li>
<li><a href="#thunkmiddleware"><code>thunkMiddleware</code></a></li>
<li><a href="#applymiddleware"><code>applyMiddleware</code></a></li>
<li><a href="#bindactioncreator"><code>bindActionCreator</code></a></li>
<li><a href="#bindactioncreator%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><code>bindActionCreator</code>源码解析</a></li>
</ul>
</li>
<li><a href="#react-redux"><code>react-redux</code></a><ul>
<li><a href="#provider"><code>Provider</code></a></li>
<li><a href="#connect"><code>connect</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="Redux入坑进阶-源码解析"><a href="#Redux入坑进阶-源码解析" class="headerlink" title="Redux入坑进阶-源码解析"></a>Redux入坑进阶-源码解析</h2><blockquote>
<p>本文不涉及redux的使用方法，因此可能更适合使用过redux的玩家翻阅😃</p>
</blockquote>
<h3 id="预热"><a href="#预热" class="headerlink" title="预热"></a>预热</h3><blockquote>
<p>redux 函数内部包含了大量<a href="https://llh911001.gitbooks.io/mostly-adequate-guide-chinese/content/ch4.html" target="_blank" rel="external">柯里化函数</a>以及<a href="https://llh911001.gitbooks.io/mostly-adequate-guide-chinese/content/ch5.html" target="_blank" rel="external">代码组合</a>思想</p>
</blockquote>
<h4 id="柯里化函数（curry）"><a href="#柯里化函数（curry）" class="headerlink" title="柯里化函数（curry）"></a>柯里化函数（<code>curry</code>）</h4><p>通俗的来讲，可以用一句话概括柯里化函数：返回函数的函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// example</span></div><div class="line"><span class="keyword">const</span> funcA = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">const</span> funcB = <span class="function">(<span class="params">b</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> a + b</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>上述的<code>funcA</code>函数接收一个参数，并返回同样接收一个参数的<code>funcB</code>函数。</p>
<p>柯里化函数有什么好处呢？</p>
<ul>
<li>避免了给一个函数传入大量的参数–我们可以通过柯里化来构建类似上例的函数嵌套，将参数的代入分离开，更有利于调试</li>
<li>降低耦合度和代码冗余，便于复用</li>
</ul>
<p>举个栗子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 已知listA, listB两个Array，都由int组成，需要筛选出两个Array的交集</span></div><div class="line"><span class="keyword">const</span> listA = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</div><div class="line"><span class="keyword">const</span> listB = [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</div><div class="line"></div><div class="line"><span class="keyword">const</span> checkIfDataExist = <span class="function">(<span class="params">list</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">target</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> list.some(<span class="function"><span class="params">value</span> =&gt;</span> value === target)</div><div class="line">  &#125;;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 调用一次checkIfDataExist函数，并将listA作为参数传入，来构建一个新的函数。</span></div><div class="line"><span class="comment">// 而新函数的作用则是：检查传入的参数是否存在于listA里</span></div><div class="line"><span class="keyword">const</span> ifDataExist = checkIfDataExist(listA);</div><div class="line"></div><div class="line"><span class="comment">// 使用新函数来对listB里的每一个元素进行筛选</span></div><div class="line"><span class="keyword">const</span> intersectionList = listB.filter(<span class="function"><span class="params">value</span> =&gt;</span> ifDataExist(value));</div><div class="line"><span class="built_in">console</span>.log(intersectionList); <span class="comment">// [2, 3, 4]</span></div></pre></td></tr></table></figure>
<h4 id="代码组合（compose）"><a href="#代码组合（compose）" class="headerlink" title="代码组合（compose）"></a>代码组合（<code>compose</code>）</h4><p>代码组合就像是数学中的结合律：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> compose = <span class="function">(<span class="params">f, g</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">x</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> f(g(x));</div><div class="line">  &#125;;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 还可以再简洁点</span></div><div class="line"><span class="keyword">const</span> compose = <span class="function">(<span class="params">f, g</span>) =&gt;</span> (x) =&gt; f(g(x));</div></pre></td></tr></table></figure>
<p>通过这样函数之间的组合，可以大大增加可读性，效果远大于嵌套一大堆的函数调用，并且我们可以随意更改函数的调用顺序</p>
<h3 id="Redux"><a href="#Redux" class="headerlink" title="Redux"></a><code>Redux</code></h3><h4 id="combineReducers"><a href="#combineReducers" class="headerlink" title="combineReducers"></a><code>combineReducers</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 回顾一下combineReducers的使用格式</span></div><div class="line"></div><div class="line"><span class="comment">// 两个reducer</span></div><div class="line"><span class="keyword">const</span> todos = <span class="function">(<span class="params">state = INIT.todos, action</span>) =&gt;</span> &#123;</div><div class="line">  <span class="comment">// ....</span></div><div class="line">&#125;;</div><div class="line"><span class="keyword">const</span> filterStatus = <span class="function">(<span class="params">state = INIT.filterStatus, action</span>) =&gt;</span> &#123;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> appReducer = combineReducers(&#123;</div><div class="line">  todos,</div><div class="line">  filterStatus</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>还记得<code>combineReducers</code>的黑魔法吗？即：</p>
<ol>
<li><p>传入的Object参数中，对象的<code>key</code>与<code>value</code>所代表的<code>reducer function</code>同名</p>
</li>
<li><p>各个<code>reducer function</code>的名称和需要传入该reducer的<code>state</code>参数同名。</p>
</li>
</ol>
</blockquote>
<p>源码标注解读（省略部分）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</div><div class="line">  <span class="comment">// 第一次筛选，参数reducers为Object</span></div><div class="line">  <span class="comment">// 筛选掉reducers中不是function的键值对</span></div><div class="line">  <span class="keyword">var</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers);</div><div class="line">  <span class="keyword">var</span> finalReducers = &#123;&#125;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; reducerKeys.length; i++) &#123;</div><div class="line">    <span class="keyword">var</span> key = reducerKeys[i];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'function'</span>) &#123;</div><div class="line">      finalReducers[key] = reducers[key]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers)</div><div class="line"></div><div class="line">  <span class="comment">// 二次筛选，判断reducer中传入的值是否合法（!== undefined）</span></div><div class="line">  <span class="comment">// 获取筛选完之后的所有key</span></div><div class="line">  <span class="keyword">var</span> sanityError</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// assertReducerSanity函数用于遍历finalReducers中的reducer，检查传入reducer的state是否合法</span></div><div class="line">    assertReducerSanity(finalReducers)</div><div class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">    sanityError = e</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">// 返回一个function。该方法接收state和action作为参数</span></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</div><div class="line">    <span class="comment">// 如果之前的判断reducers中有不法值，则抛出错误</span></div><div class="line">    <span class="keyword">if</span> (sanityError) &#123;</div><div class="line">      <span class="keyword">throw</span> sanityError</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果不是production环境则抛出warning</span></div><div class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">      <span class="keyword">var</span> warningMessage = getUnexpectedStateShapeWarningMessage(state, finalReducers, action)</div><div class="line">      <span class="keyword">if</span> (warningMessage) &#123;</div><div class="line">        warning(warningMessage)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> hasChanged = <span class="literal">false</span></div><div class="line">    <span class="keyword">var</span> nextState = &#123;&#125;</div><div class="line">    <span class="comment">// 遍历所有的key和reducer，分别将reducer对应的key所代表的state，代入到reducer中进行函数调用</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.length; i++) &#123;</div><div class="line">      <span class="keyword">var</span> key = finalReducerKeys[i]</div><div class="line">      <span class="keyword">var</span> reducer = finalReducers[key]</div><div class="line">      <span class="comment">// 这也就是为什么说combineReducers黑魔法--要求传入的Object参数中，reducer function的名称和要和state同名的原因</span></div><div class="line">      <span class="keyword">var</span> previousStateForKey = state[key]</div><div class="line">      <span class="keyword">var</span> nextStateForKey = reducer(previousStateForKey, action)</div><div class="line">      <span class="comment">// 如果reducer返回undefined则抛出错误</span></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">'undefined'</span>) &#123;</div><div class="line">        <span class="keyword">var</span> errorMessage = getUndefinedStateErrorMessage(key, action)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(errorMessage)</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 将reducer返回的值填入nextState</span></div><div class="line">      nextState[key] = nextStateForKey</div><div class="line">      <span class="comment">// 如果任一state有更新则hasChanged为true</span></div><div class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> hasChanged ? nextState : state</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 检查传入reducer的state是否合法</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">assertReducerSanity</span>(<span class="params">reducers</span>) </span>&#123;</div><div class="line">  <span class="built_in">Object</span>.keys(reducers).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">var</span> reducer = reducers[key]</div><div class="line">    <span class="comment">// 遍历全部reducer，并给它传入(undefined, action)</span></div><div class="line">    <span class="comment">// 当第一个参数传入undefined时，则为各个reducer定义的默认参数</span></div><div class="line">    <span class="keyword">var</span> initialState = reducer(<span class="literal">undefined</span>, &#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</div><div class="line">    </div><div class="line">    <span class="comment">// ActionTypes.INIT几乎不会被定义，所以会通过switch的default返回reducer的默认参数。如果没有指定默认参数，则返回undefined，抛出错误</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">'undefined'</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">        <span class="string">`Reducer "<span class="subst">$&#123;key&#125;</span>" returned undefined during initialization. `</span> +</div><div class="line">        <span class="string">`If the state passed to the reducer is undefined, you must `</span> +</div><div class="line">        <span class="string">`explicitly return the initial state. The initial state may `</span> +</div><div class="line">        <span class="string">`not be undefined.`</span></div><div class="line">      )</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> type = <span class="string">'@@redux/PROBE_UNKNOWN_ACTION_'</span> + <span class="built_in">Math</span>.random().toString(<span class="number">36</span>).substring(<span class="number">7</span>).split(<span class="string">''</span>).join(<span class="string">'.'</span>)</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducer(<span class="literal">undefined</span>, &#123; type &#125;) === <span class="string">'undefined'</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">        <span class="string">`Reducer "<span class="subst">$&#123;key&#125;</span>" returned undefined when probed with a random type. `</span> +</div><div class="line">        <span class="string">`Don't try to handle <span class="subst">$&#123;ActionTypes.INIT&#125;</span> or other actions in "redux/*" `</span> +</div><div class="line">        <span class="string">`namespace. They are considered private. Instead, you must return the `</span> +</div><div class="line">        <span class="string">`current state for any unknown actions, unless it is undefined, `</span> +</div><div class="line">        <span class="string">`in which case you must return the initial state, regardless of the `</span> +</div><div class="line">        <span class="string">`action type. The initial state may not be undefined.`</span></div><div class="line">      )</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="createStore"><a href="#createStore" class="headerlink" title="createStore"></a><code>createStore</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 回顾下使用方法</span></div><div class="line"><span class="keyword">const</span> store = createStore(reducers, state, enhance);</div></pre></td></tr></table></figure>
<p>源码标注解读（省略部分）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 对于未知的action.type，reducer必须返回默认的参数state。这个ActionTypes.INIT就可以用来监测当reducer传入未知type的action时，返回的state是否合法</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">var</span> ActionTypes = &#123;</div><div class="line">  <span class="attr">INIT</span>: <span class="string">'@@redux/INIT'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, initialState, enhancer</span>) </span>&#123;</div><div class="line">  <span class="comment">// 检查你的state和enhance参数有没有传反</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">'undefined'</span>) &#123;</div><div class="line">    enhancer = initialState</div><div class="line">    initialState = <span class="literal">undefined</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 如果有传入合法的enhance，则通过enhancer再调用一次createStore</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the enhancer to be a function.'</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> enhancer(createStore)(reducer, initialState)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> reducer !== <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the reducer to be a function.'</span>)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> currentReducer = reducer</div><div class="line">  <span class="keyword">var</span> currentState = initialState</div><div class="line">  <span class="keyword">var</span> currentListeners = []</div><div class="line">  <span class="keyword">var</span> nextListeners = currentListeners</div><div class="line">  <span class="keyword">var</span> isDispatching = <span class="literal">false</span> <span class="comment">// 是否正在分发事件</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ensureCanMutateNextListeners</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</div><div class="line">      nextListeners = currentListeners.slice()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 我们在action middleware中经常使用的getState()方法，返回当前state</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> currentState</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 注册listener，同时返回一个取消事件注册的方法。当调用store.dispatch的时候调用listener</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">'function'</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected listener to be a function.'</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> isSubscribed = <span class="literal">true</span></div><div class="line"></div><div class="line">    ensureCanMutateNextListeners()</div><div class="line">    nextListeners.push(listener)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (!isSubscribed) &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">      &#125;</div><div class="line"></div><div class="line">      isSubscribed = <span class="literal">false</span></div><div class="line">      <span class="comment">// 从nextListeners中去除掉当前listener</span></div><div class="line">      ensureCanMutateNextListeners()</div><div class="line">      <span class="keyword">var</span> index = nextListeners.indexOf(listener)</div><div class="line">      nextListeners.splice(index, <span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// dispatch方法接收的action是个对象，而不是方法。</span></div><div class="line">  <span class="comment">// 这个对象实际上就是我们自定义action的返回值，因为dispatch的时候，已经调用过我们的自定义action了，比如 dispatch(addTodo())</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!isPlainObject(action)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">        <span class="string">'Actions must be plain objects. '</span> +</div><div class="line">        <span class="string">'Use custom middleware for async actions.'</span></div><div class="line">      )</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action.type === <span class="string">'undefined'</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">        <span class="string">'Actions may not have an undefined "type" property. '</span> +</div><div class="line">        <span class="string">'Have you misspelled a constant?'</span></div><div class="line">      )</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 调用dispatch的时候只能一个个调用，通过dispatch判断调用的状态</span></div><div class="line">    <span class="keyword">if</span> (isDispatching) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Reducers may not dispatch actions.'</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      isDispatching = <span class="literal">true</span></div><div class="line">      currentState = currentReducer(currentState, action)</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      isDispatching = <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 遍历调用各个linster</span></div><div class="line">    <span class="keyword">var</span> listeners = currentListeners = nextListeners</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</div><div class="line">      listeners[i]()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> action</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// Replaces the reducer currently used by the store to calculate the state.</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> nextReducer !== <span class="string">'function'</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the nextReducer to be a function.'</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    currentReducer = nextReducer</div><div class="line">    dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 当create store的时候，reducer会接受一个type为ActionTypes.INIT的action，使reducer返回他们默认的state，这样可以快速的形成默认的state的结构</span></div><div class="line">  dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    dispatch,</div><div class="line">    subscribe,</div><div class="line">    getState,</div><div class="line">    replaceReducer</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="thunkMiddleware"><a href="#thunkMiddleware" class="headerlink" title="thunkMiddleware"></a><code>thunkMiddleware</code></h4><p>源码及其简单简直给跪…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 返回以 dispatch 和 getState 作为参数的action</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">thunkMiddleware</span>(<span class="params">&#123; dispatch, getState &#125;</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> action =&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">'function'</span>) &#123;</div><div class="line">      <span class="keyword">return</span> action(dispatch, getState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> next(action);</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="applyMiddleware"><a href="#applyMiddleware" class="headerlink" title="applyMiddleware"></a><code>applyMiddleware</code></h4><p>先复习下用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// usage</span></div><div class="line"><span class="keyword">import</span> &#123;createStore, applyMiddleware&#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">import</span> thunkMiddleware <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> store = createStore(</div><div class="line">      reducers,</div><div class="line">      state,</div><div class="line">      applyMiddleware(thunkMiddleware)</div><div class="line">);</div></pre></td></tr></table></figure>
<p><code>applyMiddleware</code>首先接收<code>thunkMiddleware</code>作为参数，两者组合成为一个新的函数（<code>enhance</code>），之后在<code>createStore</code>内部，因为<code>enhance</code>的存在，将会变成返回<code>enhancer(createStore)(reducer, initialState)</code></p>
<p>源码标注解读（省略部分）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义一个代码组合的方法</span></div><div class="line"><span class="comment">// 传入一些function作为参数，返回其链式调用的形态。例如，</span></div><div class="line"><span class="comment">// compose(f, g, h) 最终返回 (...args) =&gt; f(g(h(...args)))</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...funcs</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">const</span> last = funcs[funcs.length - <span class="number">1</span>]</div><div class="line">    <span class="keyword">const</span> rest = funcs.slice(<span class="number">0</span>, <span class="number">-1</span>)</div><div class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> rest.reduceRight(<span class="function">(<span class="params">composed, f</span>) =&gt;</span> f(composed), last(...args))</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">...middlewares</span>) </span>&#123;</div><div class="line">  <span class="comment">// 最终返回一个以createStore为参数的匿名函数</span></div><div class="line">  <span class="comment">// 这个函数返回另一个以reducer, initialState, enhancer为参数的匿名函数</span></div><div class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">createStore</span>) =&gt;</span> (reducer, initialState, enhancer) =&gt; &#123;</div><div class="line">    <span class="keyword">var</span> store = createStore(reducer, initialState, enhancer)</div><div class="line">    <span class="keyword">var</span> dispatch</div><div class="line">    <span class="keyword">var</span> chain = []</div><div class="line"></div><div class="line">    <span class="keyword">var</span> middlewareAPI = &#123;</div><div class="line">      <span class="attr">getState</span>: store.getState,</div><div class="line">      <span class="attr">dispatch</span>: <span class="function">(<span class="params">action</span>) =&gt;</span> dispatch(action)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 每个 middleware 都以 middlewareAPI 作为参数进行注入，返回一个新的链。此时的返回值相当于调用 thunkMiddleware 返回的函数： (next) =&gt; (action) =&gt; &#123;&#125; ，接收一个next作为其参数</span></div><div class="line">    chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</div><div class="line">    <span class="comment">// 并将链代入进 compose 组成一个函数的调用链</span></div><div class="line">    <span class="comment">// compose(...chain) 返回形如(...args) =&gt; f(g(h(...args)))，f/g/h都是chain中的函数对象。</span></div><div class="line">    <span class="comment">// 在目前只有 thunkMiddleware 作为 middlewares 参数的情况下，将返回 (next) =&gt; (action) =&gt; &#123;&#125;</span></div><div class="line">    <span class="comment">// 之后以 store.dispatch 作为参数进行注入</span></div><div class="line">    dispatch = compose(...chain)(store.dispatch)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      ...store,</div><div class="line">      dispatch</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一脸懵逼？没关系，来结合实际使用总结一下：</p>
<p>当我们搭配<code>redux-thunk</code>这个库的时候，在<code>redux</code>配合<code>components</code>时，通常这么写</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> thunkMiddleware <span class="keyword">from</span> <span class="string">'redux-thunk'</span>;</div><div class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware, combineReducer &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> reducers <span class="keyword">from</span> <span class="string">'./reducers.js'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> appReducer = combineReducer(reducers);</div><div class="line"><span class="keyword">const</span> store = createStore(appReducer, initialState, applyMiddleware(thunkMiddleware));</div></pre></td></tr></table></figure>
<p>还记得当<code>createStore</code>收到的参数中有<code>enhance</code>时会怎么做吗？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// createStore.js</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the enhancer to be a function.'</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> enhancer(createStore)(reducer, initialState)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也就是说，会变成下面的情况</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">applyMiddleware(thunkMiddleware)(createStore)(reducer, initialState)</div></pre></td></tr></table></figure>
<ul>
<li><code>applyMiddleware(thunkMiddleware)</code></li>
</ul>
<p><code>applyMiddleware</code>接收<code>thunkMiddleware</code>作为参数，返回形如<code>(createStore) =&gt; (reducer, initialState, enhancer) =&gt; {}</code>的函数。</p>
<ul>
<li><code>applyMiddleware(thunkMiddleware)(createStore)</code></li>
</ul>
<p>以 createStore 作为参数，调用上一步返回的函数<code>(reducer, initialState, enhancer) =&gt; {}</code></p>
<ul>
<li><code>applyMiddleware(thunkMiddleware)(createStore)(reducer, initialState)</code></li>
</ul>
<p>以（reducer, initialState）为参数进行调用。<br>在这个函数内部，<code>thunkMiddleware</code>被调用，其作用是监测<code>type</code>是<code>function</code>的<code>action</code></p>
<p>因此，如果<code>dispatch</code>的<code>action</code>返回的是一个<code>function</code>，则证明是中间件，则将<code>(dispatch, getState)</code>作为参数代入其中，进行<code>action</code> 内部下一步的操作。否则的话，认为只是一个普通的<code>action</code>，将通过<code>next</code>(也就是<code>dispatch</code>)进一步分发</p>
<hr>
<p>也就是说，<code>applyMiddleware(thunkMiddleware)</code>作为<code>enhance</code>，最终起了这样的作用：</p>
<p>对<code>dispatch</code>调用的<code>action</code>(例如，<code>dispatch(addNewTodo(todo)))</code>进行检查，如果<code>action</code>在第一次调用之后返回的是<code>function</code>，则将<code>(dispatch, getState)</code>作为参数注入到<code>action</code>返回的方法中，否则就正常对<code>action</code>进行分发，这样一来我们的中间件就完成喽~</p>
<p>因此，当<code>action</code>内部需要获取<code>state</code>，或者需要进行异步操作，在操作完成之后进行事件调用分发的话，我们就可以让<code>action</code> 返回一个以<code>(dispatch, getState)</code>为参数的<code>function</code>而不是通常的<code>Object</code>，<code>enhance</code>就会对其进行检测以便正确的处理</p>
<h4 id="bindActionCreator"><a href="#bindActionCreator" class="headerlink" title="bindActionCreator"></a><code>bindActionCreator</code></h4><blockquote>
<p>这个方法感觉比较少见，我个人也很少用到</p>
</blockquote>
<p>在传统写法下，当我们要把 state 和 action 注入到子组件中时，一般会这么做：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</div><div class="line"><span class="keyword">import</span> &#123;addTodo, deleteTodo&#125; <span class="keyword">from</span> <span class="string">'./action.js'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TodoComponect</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">ChildComponent</span> </span></span></div><div class="line">        <span class="attr">deleteTodo</span>=<span class="string">&#123;this.props.deleteTodo&#125;</span></div><div class="line">        <span class="attr">addTodo</span>=<span class="string">&#123;this.props.addTodo&#125;</span></div><div class="line">      /&gt;</div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function mapStateToProps(state) &#123;</div><div class="line">  return &#123;</div><div class="line">    state</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">function mapDispatchToProps(dispatch) &#123;</div><div class="line">  return &#123;</div><div class="line">    deleteTodo: (id) =&gt; &#123;</div><div class="line">      dispatch(deleteTodo(id));</div><div class="line">    &#125;,</div><div class="line">    addTodo: (todo) =&gt; &#123;</div><div class="line">      dispatch(addTodo(todo));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">export default connect(mapStateToProps, mapDispatchToProps)(TodoComponect);</div></pre></td></tr></table></figure>
<p>使用<code>bindActionCreators</code>可以把 action 转为同名 key 的对象，但使用 dispatch 把每个 action 包围起来调用</p>
<p><em>惟一使用 bindActionCreators 的场景是当你需要把 action creator 往下传到一个组件上，却不想让这个组件觉察到 Redux 的存在，而且不希望把 Redux store 或 dispatch 传给它</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; bindActionCreators &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</div><div class="line"><span class="keyword">import</span> &#123;addTodo, deleteTodo&#125; <span class="keyword">as</span> TodoActions <span class="keyword">from</span> <span class="string">'./action.js'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TodoComponect</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  </div><div class="line">  <span class="comment">// 在本组件内的应用</span></div><div class="line">  addTodo(todo) &#123;</div><div class="line">    <span class="keyword">let</span> action = TodoActions.addTodo(todo);</div><div class="line">    <span class="keyword">this</span>.props.dispatch(action);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  deleteTodo(id) &#123;</div><div class="line">    <span class="keyword">let</span> action = TodoActions.deleteTodo(id);</div><div class="line">    <span class="keyword">this</span>.props.dispatch(action);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">let</span> dispatch = <span class="keyword">this</span>.props.dispatch;</div><div class="line">    <span class="comment">// 传递给子组件</span></div><div class="line">    <span class="keyword">let</span> boundActionCreators = bindActionCreators(TodoActions, dispatch);</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">ChildComponent</span> </span></span></div><div class="line">        &#123;<span class="attr">...boundActionCreators</span>&#125;</div><div class="line">      /&gt;</div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function mapStateToProps(state) &#123;</div><div class="line">  return &#123;</div><div class="line">    state</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">export default connect(mapStateToProps)(TodoComponect)</div></pre></td></tr></table></figure>
<h4 id="bindActionCreator源码解析"><a href="#bindActionCreator源码解析" class="headerlink" title="bindActionCreator源码解析"></a><code>bindActionCreator</code>源码解析</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(actionCreator(...args))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// bindActionCreators期待一个Object作为actionCreators传入，里面是 key: action</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) </span>&#123;</div><div class="line">  <span class="comment">// 如果只是传入一个action，则通过bindActionCreator返回被绑定到dispatch的函数</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators === <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> bindActionCreator(actionCreators, dispatch)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators !== <span class="string">'object'</span> || actionCreators === <span class="literal">null</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">      <span class="string">`bindActionCreators expected an object or a function, instead received <span class="subst">$&#123;actionCreators === <span class="literal">null</span> ? <span class="string">'null'</span> : <span class="keyword">typeof</span> actionCreators&#125;</span>. `</span> +</div><div class="line">      <span class="string">`Did you write "import ActionCreators from" instead of "import * as ActionCreators from"?`</span></div><div class="line">    )</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 遍历并通过bindActionCreator分发绑定至dispatch</span></div><div class="line">  <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(actionCreators)</div><div class="line">  <span class="keyword">var</span> boundActionCreators = &#123;&#125;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</div><div class="line">    <span class="keyword">var</span> key = keys[i]</div><div class="line">    <span class="keyword">var</span> actionCreator = actionCreators[key]</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">'function'</span>) &#123;</div><div class="line">      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> boundActionCreators</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="react-redux"><a href="#react-redux" class="headerlink" title="react-redux"></a><code>react-redux</code></h3><h4 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a><code>Provider</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  getChildContext() &#123;</div><div class="line">    <span class="comment">// 将其声明为 context 的属性之一</span></div><div class="line">    <span class="keyword">return</span> &#123; <span class="attr">store</span>: <span class="keyword">this</span>.store &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">constructor</span>(props, context) &#123;</div><div class="line">    <span class="keyword">super</span>(props, context)</div><div class="line">    <span class="comment">// 接收 redux 的 store 作为 props</span></div><div class="line">    <span class="keyword">this</span>.store = props.store</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> Children.only(<span class="keyword">this</span>.props.children)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">  Provider.prototype.componentWillReceiveProps = <span class="function"><span class="keyword">function</span> (<span class="params">nextProps</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span></div><div class="line">    <span class="keyword">const</span> &#123; <span class="attr">store</span>: nextStore &#125; = nextProps</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (store !== nextStore) &#123;</div><div class="line">      warnAboutReceivingStore()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Provider.propTypes = &#123;</div><div class="line">  <span class="attr">store</span>: storeShape.isRequired,</div><div class="line">  <span class="attr">children</span>: PropTypes.element.isRequired</div><div class="line">&#125;</div><div class="line">Provider.childContextTypes = &#123;</div><div class="line">  <span class="attr">store</span>: storeShape.isRequired</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="connect"><a href="#connect" class="headerlink" title="connect"></a><code>connect</code></h4><p>传入<code>mapStateToProps</code>,<code>mapDispatchToProps</code>,<code>mergeProps</code>,<code>options</code>。<br>首先获取传入的参数，如果没有则以默认值代替</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> defaultMapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;&#125;) <span class="comment">// eslint-disable-line no-unused-vars</span></div><div class="line"><span class="keyword">const</span> defaultMapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> (&#123; dispatch &#125;)</div><div class="line"><span class="keyword">const</span> &#123; pure = <span class="literal">true</span>, withRef = <span class="literal">false</span> &#125; = options</div></pre></td></tr></table></figure>
<p>之后，通过</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> finalMergeProps = mergeProps || defaultMergeProps</div></pre></td></tr></table></figure>
<p>选择合并<code>stateProps</code>,<code>dispatchProps</code>,<code>parentProps</code>的方式，默认的合并方式 <code>defaultMergeProps</code> 为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> defaultMergeProps = <span class="function">(<span class="params">stateProps, dispatchProps, parentProps</span>) =&gt;</span> (&#123;</div><div class="line">  ...parentProps,</div><div class="line">  ...stateProps,</div><div class="line">  ...dispatchProps</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>返回一个以 Component 作为参数的函数。在这个函数内部，生成了一个叫做<code>Connect</code>的 Component</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ...</span></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapWithConnect</span>(<span class="params">WrappedComponent</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> connectDisplayName = <span class="string">`Connect(<span class="subst">$&#123;getDisplayName(WrappedComponent)&#125;</span>)`</span></div><div class="line">    <span class="comment">// 检查参数合法性</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkStateShape</span>(<span class="params">props, methodName</span>) </span>&#123;&#125;</div><div class="line">    <span class="comment">// 合并props</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">computeMergedProps</span>(<span class="params">stateProps, dispatchProps, parentProps</span>) </span>&#123;</div><div class="line">      <span class="keyword">const</span> mergedProps = finalMergeProps(stateProps, dispatchProps, parentProps)</div><div class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">        checkStateShape(mergedProps, <span class="string">'mergeProps'</span>)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> mergedProps</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// start of Connect</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">      <span class="keyword">constructor</span>(props, context) &#123;</div><div class="line">        <span class="keyword">super</span>(props, context);</div><div class="line">        <span class="keyword">this</span>.store = props.store || context.store</div><div class="line">        </div><div class="line">        <span class="keyword">const</span> storeState = <span class="keyword">this</span>.store.getState()</div><div class="line">        <span class="keyword">this</span>.state = &#123; storeState &#125;</div><div class="line">        <span class="keyword">this</span>.clearCache()</div><div class="line">      &#125;</div><div class="line">      </div><div class="line">      computeStateProps(store, props) &#123;</div><div class="line">        <span class="comment">// 调用configureFinalMapState，使用传入的mapStateToProps方法（或默认方法），将state map进props</span></div><div class="line">      &#125;</div><div class="line">      configureFinalMapState(store, props) &#123;&#125;</div><div class="line">      </div><div class="line">      computeDispatchProps(store, props) &#123;</div><div class="line">        <span class="comment">// 调用configureFinalMapDispatch，使用传入的mapDispatchToProps方法（或默认方法），将action使用dispatch封装map进props</span></div><div class="line">      &#125;</div><div class="line">      configureFinalMapDispatch(store, props) &#123;&#125;</div><div class="line">      </div><div class="line">      <span class="comment">// 判断是否更新props</span></div><div class="line">      updateStatePropsIfNeeded() &#123;&#125;</div><div class="line">      updateDispatchPropsIfNeeded() &#123;&#125;</div><div class="line">      updateMergedPropsIfNeeded() &#123;&#125;</div><div class="line">      </div><div class="line">      componentDidMount() &#123;</div><div class="line">        <span class="comment">// 内部调用this.store.subscribe(this.handleChange.bind(this))</span></div><div class="line">        <span class="keyword">this</span>.trySubscribe()</div><div class="line">      &#125;</div><div class="line">      handleChange() &#123;</div><div class="line">        <span class="keyword">const</span> storeState = <span class="keyword">this</span>.store.getState()</div><div class="line">        <span class="keyword">const</span> prevStoreState = <span class="keyword">this</span>.state.storeState</div><div class="line">        <span class="comment">// 对数据进行监听，发送改变时调用</span></div><div class="line">        <span class="keyword">this</span>.setState(&#123; storeState &#125;)</div><div class="line">      &#125;</div><div class="line">      </div><div class="line">      <span class="comment">// 取消监听，清除缓存</span></div><div class="line">      componentWillUnmount() &#123;</div><div class="line">        <span class="keyword">this</span>.tryUnsubscribe()</div><div class="line">        <span class="keyword">this</span>.clearCache()</div><div class="line">      &#125;</div><div class="line">      </div><div class="line">      render() &#123;</div><div class="line">        <span class="keyword">this</span>.renderedElement = createElement(WrappedComponent,</div><div class="line">            <span class="keyword">this</span>.mergedProps</div><div class="line">        )</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.renderedElement</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// end of Connect</span></div><div class="line">    </div><div class="line">    Connect.displayName = connectDisplayName</div><div class="line">    Connect.WrappedComponent = WrappedComponent</div><div class="line">    Connect.contextTypes = &#123;</div><div class="line">      <span class="attr">store</span>: storeShape</div><div class="line">    &#125;</div><div class="line">    Connect.propTypes = &#123;</div><div class="line">      <span class="attr">store</span>: storeShape</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> hoistStatics(Connect, WrappedComponent)</div><div class="line">  &#125;</div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure>
<p>我们看见，在connect的最后，返回了使用<code>hoistStatics</code>包装的<code>Connect</code>和<code>WrappedComponent</code></p>
<p><a href="https://github.com/mridgway/hoist-non-react-statics" target="_blank" rel="external">hoistStatics</a>是什么鬼？<a href="https://github.com/reactjs/react-redux/issues/276" target="_blank" rel="external">为什么使用它?</a></p>
<blockquote>
<p>Copies non-react specific statics from a child component to a parent component. Similar to Object.assign, but with React static keywords blacklisted from being overridden.</p>
</blockquote>
<p>也就是说，它类似于<code>Object.assign</code>，作用是将子组件中的 static 方法复制进父组件，但不会覆盖组件中的关键字方法(如 componentDidMount)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> hoistNonReactStatic <span class="keyword">from</span> <span class="string">'hoist-non-react-statics'</span>;</div><div class="line"></div><div class="line">hoistNonReactStatic(targetComponent, sourceComponent);</div></pre></td></tr></table></figure>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/Coding-Guide/">Home</a></li>
         
          <li><a href="/Coding-Guide/about/">About</a></li>
         
          <li><a href="/Coding-Guide/archives/">Articles</a></li>
         
          <li><a href="http://github.com/ecmadao">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redux入坑进阶-源码解析"><span class="toc-number">1.</span> <span class="toc-text">Redux入坑进阶-源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#预热"><span class="toc-number">1.1.</span> <span class="toc-text">预热</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#柯里化函数（curry）"><span class="toc-number">1.1.1.</span> <span class="toc-text">柯里化函数（curry）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代码组合（compose）"><span class="toc-number">1.1.2.</span> <span class="toc-text">代码组合（compose）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redux"><span class="toc-number">1.2.</span> <span class="toc-text">Redux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#combineReducers"><span class="toc-number">1.2.1.</span> <span class="toc-text">combineReducers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#createStore"><span class="toc-number">1.2.2.</span> <span class="toc-text">createStore</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#thunkMiddleware"><span class="toc-number">1.2.3.</span> <span class="toc-text">thunkMiddleware</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#applyMiddleware"><span class="toc-number">1.2.4.</span> <span class="toc-text">applyMiddleware</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bindActionCreator"><span class="toc-number">1.2.5.</span> <span class="toc-text">bindActionCreator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bindActionCreator源码解析"><span class="toc-number">1.2.6.</span> <span class="toc-text">bindActionCreator源码解析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#react-redux"><span class="toc-number">1.3.</span> <span class="toc-text">react-redux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Provider"><span class="toc-number">1.3.1.</span> <span class="toc-text">Provider</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#connect"><span class="toc-number">1.3.2.</span> <span class="toc-text">connect</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&text=Redux入坑进阶-源码解析"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&title=Redux入坑进阶-源码解析"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&is_video=false&description=Redux入坑进阶-源码解析"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Redux入坑进阶-源码解析&body=Check out this article: http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&title=Redux入坑进阶-源码解析"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&title=Redux入坑进阶-源码解析"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&title=Redux入坑进阶-源码解析"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&title=Redux入坑进阶-源码解析"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://ecmadao.com/Coding-Guide/2017/01/13/Notes/React/Redux/Redux入坑进阶-源码解析/&name=Redux入坑进阶-源码解析&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 ecmadao
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/Coding-Guide/">Home</a></li>
         
          <li><a href="/Coding-Guide/about/">About</a></li>
         
          <li><a href="/Coding-Guide/archives/">Articles</a></li>
         
          <li><a href="http://github.com/ecmadao">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    <script src="/Coding-Guide/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/Coding-Guide/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'ecmadao-blog';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
